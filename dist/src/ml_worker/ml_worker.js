import{V as f}from"../../assets/vector_db-ETc79CbY.js";class w{constructor(){this.db=new f,this.userProfile=null,this.isInitialized=!1}async init(){await this.db.init();const i=await this.db.get("USER_PROFILE");i?this.userProfile=i:this.userProfile={vector:new Float32Array(384).fill(0),id:"USER_PROFILE"},this.isInitialized=!0,console.log("TasteOS: Engine initialized")}async getEmbedding(i){const e=new Float32Array(384);for(let t=0;t<384;t++)e[t]=Math.random()-.5;return this.db.normalize(e)}async scoreItems(i){const s=[];for(const e of i){let t;const o=await this.db.get(e.id);o?t=o.vector:(t=await this.getEmbedding(e.text),await this.db.add({id:e.id,text:e.text,vector:t,timestamp:Date.now(),weight:1}));const n=this.db.cosineSimilarity(t,this.userProfile.vector),r=(Date.now()-(e.timestamp||Date.now()))/(1e3*60*60),l=Math.exp(-r/36),d=o&&o.weight||1,h=.7*n+.2*d+.1*l;s.push({...e,score:h,vector:t})}return s}async updateUserProfile(i,s){const e=await this.db.get(i);if(!e)return;let t=0;switch(s){case"click":t=.3;break;case"long_view":t=.6;break;case"short_view":t=-.3;break;case"skip":t=-.5;break}e.weight=(e.weight||1)+t,await this.db.add(e);const o=.1,n=t>0?1:-1;for(let r=0;r<this.userProfile.vector.length;r++)this.userProfile.vector[r]+=n*o*e.vector[r];this.userProfile.vector=this.db.normalize(this.userProfile.vector),await this.db.add(this.userProfile)}}console.log("TasteOS: ML Worker loaded");const a=new w;a.init();self.onmessage=async c=>{const{type:i,payload:s,requestId:e}=c.data;if(i==="SCORE_ITEMS"){a.isInitialized||await a.init();const t=await a.scoreItems(s);self.postMessage({type:"SCORES_UPDATED",payload:t,requestId:e})}i==="LOG_INTERACTION"&&(a.isInitialized||await a.init(),await a.updateUserProfile(s.itemId,s.type))};
