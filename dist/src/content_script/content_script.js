class g{constructor(){this.sitePatterns={youtube:{host:"youtube.com",itemSelector:"ytd-rich-item-renderer, ytd-video-renderer, ytd-grid-video-renderer",titleSelector:"#video-title, #video-title-link",textSelector:"#description-text, .ytd-video-renderer",adSelector:".ytd-ad-slot-renderer, ytd-ad-slot-renderer"},reddit:{host:"reddit.com",itemSelector:"shreddit-post, .Post",titleSelector:'[slot="title"], h3',textSelector:'[slot="text-body"], .RichTextJSON-root',adSelector:".promoted, .promotedlink"}},this.currentPattern=null}detectSite(){const e=window.location.hostname;return e.includes("youtube.com")?this.sitePatterns.youtube:e.includes("reddit.com")?this.sitePatterns.reddit:null}scan(){this.currentPattern=this.detectSite();let e=[];return this.currentPattern?e=this.scanKnownSite(this.currentPattern):e=this.scanGeneric(),e}scanKnownSite(e){const t=document.querySelectorAll(e.itemSelector),r=[];return t.forEach(s=>{if(this.isSponsored(s,e)){s.dataset.tasteOsSponsored="true";return}const o=s.querySelector(e.titleSelector),i=s.querySelector(e.textSelector);o&&r.push({element:s,id:this.generateId(s),title:o.innerText.trim(),text:i?i.innerText.trim():"",timestamp:Date.now()})}),r}observe(e){if(this.currentPattern||(this.currentPattern=this.detectSite()),!this.currentPattern)return;const t=new MutationObserver(s=>{let o=!1;for(const i of s)if(i.addedNodes.length>0){o=!0;break}o&&(this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{const i=this.scan();e(i)},1e3))}),r=document.querySelector(this.currentPattern.itemSelector);r&&r.parentElement?(t.observe(r.parentElement,{childList:!0,subtree:!0}),console.log("TasteOS: Observer started on",r.parentElement)):(t.observe(document.body,{childList:!0,subtree:!0}),console.log("TasteOS: Observer started on body"))}scanGeneric(){return[]}isSponsored(e,t){if(t.adSelector&&e.querySelector(t.adSelector))return!0;const r=e.innerText.toLowerCase();return r.includes("sponsored")||r.includes("promoted")||r.includes("ad")}generateId(e){const t=e.querySelector("a");return t&&t.href?t.href:"item-"+Math.random().toString(36).substr(2,9)}}class v{constructor(){this.isReordering=!1}reorder(e){this.isReordering||(this.isReordering=!0,requestAnimationFrame(()=>{try{this.performReorder(e)}catch(t){console.error("TasteOS: Reorder failed",t)}finally{this.isReordering=!1}}))}performReorder(e){[...e].sort((r,s)=>s.score-r.score);const t=new Map;e.forEach(r=>{const s=r.element.parentElement;t.has(s)||t.set(s,[]),t.get(s).push(r)}),t.forEach((r,s)=>{const o=Array.from(s.children),i=new Set;o.forEach((n,d)=>{n.dataset.tasteOsSponsored==="true"&&i.add(d)}),document.createDocumentFragment();const l=r.filter(n=>n.element.dataset.tasteOsSponsored!=="true");l.sort((n,d)=>d.score-n.score);let u=0;const a=[];o.forEach(n=>{n.dataset.tasteOsSponsored==="true"?a.push(n):r.find(S=>S.element===n)?u<l.length&&(a.push(l[u].element),u++):a.push(n)}),a.forEach(n=>s.appendChild(n))})}}class T{constructor(){this.observer=new IntersectionObserver(this.handleIntersection.bind(this),{threshold:[.5]}),this.viewStartTimes=new Map}track(e,t){e.dataset.tasteOsId=t,this.observer.observe(e),e.addEventListener("click",()=>{this.sendEvent("click",t)})}handleIntersection(e){e.forEach(t=>{const r=t.target.dataset.tasteOsId;if(r)if(t.isIntersecting)this.viewStartTimes.set(r,Date.now());else{const s=this.viewStartTimes.get(r);if(s){const o=Date.now()-s;this.viewStartTimes.delete(r),o>1e4?this.sendEvent("long_view",r):o<1e3&&this.sendEvent("short_view",r)}}})}sendEvent(e,t){console.log("TasteOS: Interaction",e,t),chrome.runtime.sendMessage({action:"LOG_INTERACTION",payload:{type:e,itemId:t,timestamp:Date.now()}})}}console.log("TasteOS: Content script loaded");const h=new g,m=new v,f=new T;setTimeout(()=>{h.observe(e=>{console.log("TasteOS: New items detected:",e.length),e.forEach(t=>f.track(t.element,t.id)),chrome.runtime.sendMessage({action:"SCORE_ITEMS",payload:e},t=>{t&&(console.log("TasteOS: Received scores for",t.length,"items"),m.reorder(t))})});const c=h.scan();console.log("TasteOS: Initial items:",c.length),c.length>0&&(c.forEach(e=>f.track(e.element,e.id)),chrome.runtime.sendMessage({action:"SCORE_ITEMS",payload:c},e=>{e&&(console.log("TasteOS: Received scores for",e.length,"items"),m.reorder(e))}))},2e3);
